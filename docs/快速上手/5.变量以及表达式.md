# 变量以及表达式

:::danger

在最新的版本中，表达式取值语法由`{}`变为了`${}`。

若下文中若出现`{}`字样的取值语法则属于文档错误。请自动无视

:::

## 一. 赋值语法

变量的基本赋值语法为:`变量名<-变量值`

例如:

```tex
[群]你好
A<-你好
B<-1
C<-hello world
D<-{"a":"1","b":"2","c":[1,2,3]}
E<-[1,2,3,4,{"a":"1","b":"2"}]
F<-///
你好
这是一个程序
///
```

D，E为JSON字符，他们会被解析为`集合`，供你获取。

F为字符串模板，使用这样的语法来将一个多行的字符串塞入一个变量中。

:::danger

由于JSON的优先级比模板高，因此下面的表达式会解析成字符串而不是对象：

`A<-{"a":"${qwq}"}`



出于安全考虑，建议您渐进式的构建对象，如：

```text
A<-{}
${A.b}=1
${A.c}=[]
${A.c(add)}=1
```



:::

字符串模板需要和控制语句对齐，不然会抛错。

> 字符串模板支持输入变量，例如
>
> ```text
> A<-1
> 如果:${A}==1
>  A<-///{
>  "a":[${A}+1],
>  "b":2,
>  "c":3
>  }
>  ///
> {A}
> ```

## 二. 取值语法

变量的取值语法使用花括号，即:`${变量名}`

在上面的例子中：

$`{A}`展示的是`你好`，B，C同理。

若要获取D中b的值，只需写入`${D.b}`。不出意外，执行结果是`2`

若要获取E中第一个元素的值，只需写入`${E(0)}`，不出意外，执行结果为`1`

:::tip

写入`{D}`会输出D代表的JSON字符串

:::

将上面的例子加入其中，得到下面的词库：

```text
[群]你好
A<-你好
B<-1
C<-hello world
D<-{"a":"1","b":"2","c":[1,2,3]}
E<-[1,2,3,4,{"a":"1","b":"2"}]
A的值为${A}\n
B的值为${B}\n
C的值为${C}\n
D的值为${D}\n
E的值为${E}\n
D中a元素的值为${D.a}\n
D中c元素的值为${D.c}\n
D中c元素的第一个元素为${D.c(0)}\n
E中第5个元素的a属性的值为${E(4).a}
```

> ### 取值语法的高级运用:
>
> 1. 取值语法的变量名可以为花括号表达式，此时该语句的含义变为**将左侧表达式指向的值修改为右侧的计算结果，例如:**
>
>    ```text
>    [群]qwq
>    A<-{"A":1,"B":2,"C":{"A":3,"B":4,"C":[1,2,3,4]},"D":[1,2,3,{"114":514}]}
>    C<-qwq
>    ${A.D(3).114}<-${C}
>    ${A}\n
>    ${A.D(0)}<-${C}
>    ${A}\n
>    ${A.D}<-${C}
>    ${A}\n
>    ${A}<-${C}
>    ${A}\n
>    ```
>
>    不出意外词库的运行结果为:
>
>    ```text
>    {"A":1,"B":2,"C":{"A":3,"B":4,"C":[1,2,3,4]},"D":[1,2,3,{"114":"qwq"}]}
>    {"A":1,"B":2,"C":{"A":3,"B":4,"C":[1,2,3,4]},"D":["qwq",2,3,{"114":"qwq"}]}
>    {"A":1,"B":2,"C":{"A":3,"B":4,"C":[1,2,3,4]},"D":"qwq"}
>    qwq
>    ```
>
> 2. 对于数组赋值，遵循以下规矩：
>
>    - `数组名(下标)`代表替换下标处的元素为一个新元素
>    - `数组名(add)`代表在数组的末尾处添加一个新元素
>    - `数组名(add数字)`代表在数组的下标**前**添加一个新元素
>
>    例如：
>
>    ```text
>    [群]数组赋值测试
>    A<-///[
>    1,2
>    ]
>    ///
>    ${A(0)}<-3
>    ${A}\n
>    ${A(add)}<-0
>    ${A}\n
>    ${A(add2)}<-1
>    ${A}\n
>    ```
>
>    不出意外，词库的运行结果为：
>
>    ```text
>    [3,2]
>    [3,2,0]
>    [3,2,1,0]
>    ```
>
>    

## 三. 计算块

计算块可以嵌入到取值表达式中。当然，取值表达式也可以嵌入到计算块中。

计算块的语法为:`$[数学表达式]`

> 计算块使用`exp4j`框架的支持，有关`exp4j`的更多信息，请参考[https://ibit.tech/archives/exp4j-introduction](https://ibit.tech/archives/exp4j-introduction)

### 三.一 计算块的函数支持

计算块支持使用函数，调用形式为`函数名(变量1,变量2...)`

可用的函数名如下：

| 函数   | 参数数量 | 功能                                                         |
| ------ | -------- | ------------------------------------------------------------ |
| sin    | 1        | 正弦                                                         |
| cos    | 1        | 余弦                                                         |
| tan    | 1        | 正切                                                         |
| cot    | 1        | 余切                                                         |
| log    | 1        | 取对数，底数为e(2.71828...)                                  |
| log2   | 1        | 取对数，底数为2                                              |
| log10  | 1        | 取对数，底数为10                                             |
| abs    | 1        | 绝对值                                                       |
| asin   | 1        | 反正弦                                                       |
| acos   | 1        | 反余弦                                                       |
| atan   | 1        | 反正切                                                       |
| cbrt   | 1        | 开立方                                                       |
| sinh   | 1        | 双曲正弦函数                                                 |
| sqrt   | 1        | 开平方                                                       |
| tanh   | 1        | 双曲正切                                                     |
| cosh   | 1        | 双曲余弦                                                     |
| ceil   | 1        | 向上取整                                                     |
| pow    | 2        | 幂指数运算。 第一个参数为底数，第二个原数为指数。 相比`^`，pow函数的隐藏bug可能更少 |
| empm1  | 1        | 返回e^x-1                                                    |
| signum | 1        | 符号函数sgn(x)                                               |

### 三.二 计算块的运算符支持

下面是计算块可以写入的运算符：

| 运算符 | 解释                           |
| ------ | ------------------------------ |
| +      | 两个数相加                     |
| -      | 两个数相减，或对一个数取相反数 |
| *      | 两个数相乘                     |
| /      | 两个数相除                     |
| ^      | 两个数做乘幂                   |
| %      | 取余运算                       |

